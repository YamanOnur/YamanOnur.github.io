<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onur Yaman's Final AI Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print, #form-panel { display: none !important; }
            #output-container { display: block !important; box-shadow: none !important; margin: 0 !important; border: none !important; }
        }
        #output-container { display:none; }
        .agent-button {
             background-color: #db2777; /* Pink */
             color: white;
        }
        .agent-button:hover { background-color: #be185d; }
        .agent-button:disabled { background-color: #f9a8d4; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="form-panel" class="max-w-4xl mx-auto p-6 my-10 bg-white rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Final AI Cover Letter Builder</h1>

        <!-- Personal & API Information -->
        <fieldset class="mb-6 border p-4 rounded-md">
            <legend class="text-xl font-semibold px-2">Your Information & API Key</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" oninput="saveState()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Phone</label>
                    <input id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" oninput="saveState()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" oninput="saveState()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                    <input type="password" id="apiKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="sk-..." oninput="saveState()">
                </div>
            </div>
        </fieldset>

        <!-- Company Information -->
        <fieldset class="mb-6 border p-4 rounded-md">
            <legend class="text-xl font-semibold px-2">Company Information</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input id="companyName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" oninput="saveState()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Hiring Manager Name</label>
                    <input id="hiringManager" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., Ms. Jones or Hiring Team" oninput="saveState()">
                </div>
            </div>
        </fieldset>

        <!-- Dynamic Chapters -->
        <fieldset class="border p-4 rounded-md">
            <legend class="text-xl font-semibold px-2">Letter Chapters</legend>
            <div class="flex items-end gap-4 mb-4">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">New Chapter Headline</label>
                    <input type="text" id="chapter-headline" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., Introduction">
                </div>
                <button onclick="addChapter()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Chapter</button>
            </div>
            <div id="chapters-container" class="space-y-4">
                <!-- Chapters will be added here dynamically -->
            </div>
        </fieldset>

        <!-- Action Buttons -->
        <div class="mt-8 flex justify-between items-center">
             <button id="refine-all-button" onclick="activateAIAgent()" class="px-6 py-3 rounded-md shadow-sm text-base font-medium agent-button">
                ðŸ¤– Activate AI Agent (Create Draft)
            </button>
            <div class="flex space-x-4">
                <button onclick="resetForNewApplication()" class="px-6 py-2 border rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Reset Application</button>
                <button onclick="generatePDF()" class="px-6 py-2 bg-green-600 text-white rounded-md shadow-sm">Generate PDF</button>
            </div>
        </div>
    </div>

    <!-- OUTPUT CONTAINER (For PDF generation) -->
    <div id="output-container" class="max-w-3xl mx-auto p-10 my-10 bg-white">
        <div class="text-center mb-10">
            <h1 id="output-name" class="text-4xl font-bold text-gray-900"></h1>
            <div id="output-contact" class="text-sm text-gray-600 mt-2"></div>
        </div>
        <div class="mb-8">
            <p id="output-date" class="mb-4"></p>
            <p id="output-hiringManager" class="font-semibold"></p>
            <p id="output-companyName"></p>
        </div>
        <div>
            <p class="mb-6">Dear <span id="output-salutation"></span>,</p>
            <div id="output-letterBody" class="space-y-4 whitespace-pre-wrap"></div>
            <p class="mt-8">Sincerely,</p>
            <p id="output-signature" class="mt-4 font-semibold"></p>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'aiCoverLetterBuilderState';

        // --- STATE MANAGEMENT ---
        function saveState() {
            const chapters = [];
            document.querySelectorAll('#chapters-container > div').forEach(chapterDiv => {
                chapters.push({
                    id: chapterDiv.id,
                    headline: chapterDiv.querySelector('h3').innerText,
                    notes: chapterDiv.querySelector('.notes-text').value,
                    content: chapterDiv.querySelector('.content-text').value
                });
            });

            const state = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                apiKey: document.getElementById('apiKey').value,
                companyName: document.getElementById('companyName').value,
                hiringManager: document.getElementById('hiringManager').value,
                chapters: chapters
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const state = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (!state) {
                document.getElementById('name').value = 'Onur Yaman';
                return;
            }
            document.getElementById('name').value = state.name || 'Onur Yaman';
            document.getElementById('phone').value = state.phone || '';
            document.getElementById('email').value = state.email || '';
            document.getElementById('apiKey').value = state.apiKey || '';
            document.getElementById('companyName').value = state.companyName || '';
            document.getElementById('hiringManager').value = state.hiringManager || '';
            if (state.chapters) {
                state.chapters.forEach(ch => createChapterElement(ch.id, ch.headline, ch.notes, ch.content));
            }
        }

        // --- DYNAMIC CHAPTERS ---
        function addChapter() {
            const headlineInput = document.getElementById('chapter-headline');
            const headlineText = headlineInput.value.trim();
            if (!headlineText) return;
            createChapterElement('chapter-' + Date.now(), headlineText, '', '');
            headlineInput.value = '';
            saveState();
        }

        function createChapterElement(id, headline, notes = '', content = '') {
            const container = document.getElementById('chapters-container');
            const chapterDiv = document.createElement('div');
            chapterDiv.id = id;
            chapterDiv.className = 'p-4 border rounded-md bg-gray-50';
            chapterDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold text-lg text-gray-800">${headline}</h3>
                    <button onclick="removeChapter('${id}')" class="text-red-500 hover:text-red-700 font-semibold">Remove</button>
                </div>
                <label class="block text-sm font-medium text-gray-600">Your Rough Notes (can be Turkish)</label>
                <textarea class="notes-text mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows="3" oninput="saveState()">${notes}</textarea>
                <label class="block text-sm font-medium text-gray-600 mt-3">Final Paragraph (Editable Draft)</label>
                <textarea class="content-text mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-white" rows="5" oninput="saveState()">${content}</textarea>
            `;
            container.appendChild(chapterDiv);
        }
        
        function removeChapter(id) {
            document.getElementById(id).remove();
            saveState();
        }

        // --- AI AGENT ---
        async function activateAIAgent() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('Please enter your OpenAI API Key.');
                return;
            }

            const agentButton = document.getElementById('refine-all-button');
            agentButton.disabled = true;
            agentButton.innerText = 'ðŸ¤– Agent is writing...';

            const chapterNotes = [];
            document.querySelectorAll('#chapters-container > div').forEach(chapterDiv => {
                chapterNotes.push({
                    id: chapterDiv.id,
                    headline: chapterDiv.querySelector('h3').innerText,
                    notes: chapterDiv.querySelector('.notes-text').value
                });
            });

            if (chapterNotes.every(ch => !ch.notes.trim())) {
                alert("Please write some rough notes in at least one chapter before activating the agent.");
                agentButton.disabled = false;
                agentButton.innerText = 'ðŸ¤– Activate AI Agent (Create Draft)';
                return;
            }

            const systemPrompt = `You are an expert career coach writing a cover letter. The user will provide a list of chapters with headlines and rough notes (which may be in Turkish). Your task is to:
1.  Understand the intent of all notes holistically.
2.  Write a formal, natural, and effective paragraph in C1-level English for EACH chapter.
3.  Return the entire cover letter as a JSON array, where each object has an "id" and its corresponding refined "paragraph".
4.  Ensure the paragraphs flow well together as a complete letter.
The JSON structure MUST be: [{"id": "chapter-id-1", "paragraph": "Refined text for chapter 1..."}, {"id": "chapter-id-2", "paragraph": "Refined text for chapter 2..."}]`;
            
            const userPrompt = `Here are the chapters and my notes for the cover letter. Please refine them into a complete draft:\n\n${JSON.stringify(chapterNotes, null, 2)}`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-5",
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                // The API now returns a JSON object with a key that contains the array. Let's find it.
                const responseKey = Object.keys(JSON.parse(data.choices[0].message.content))[0];
                const refinedChapters = JSON.parse(data.choices[0].message.content)[responseKey];

                refinedChapters.forEach(refinedChapter => {
                    const chapterElement = document.getElementById(refinedChapter.id);
                    if (chapterElement) {
                        chapterElement.querySelector('.content-text').value = refinedChapter.paragraph;
                    }
                });
                saveState(); // Save the new AI-generated content

            } catch (error) {
                console.error('Error calling OpenAI:', error);
                alert(`An error occurred. Please check the console for details. Error: ${error.message}`);
            } finally {
                agentButton.disabled = false;
                agentButton.innerText = 'ðŸ¤– Activate AI Agent (Create Draft)';
            }
        }

        // --- PDF & RESET ---
        function generatePDF() {
            document.getElementById('output-name').innerText = document.getElementById('name').value;
            const contactInfo = [document.getElementById('phone').value, document.getElementById('email').value].filter(Boolean).join(' | ');
            document.getElementById('output-contact').innerText = contactInfo;
            document.getElementById('output-date').innerText = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const hiringManager = document.getElementById('hiringManager').value;
            document.getElementById('output-hiringManager').innerText = hiringManager;
            document.getElementById('output-companyName').innerText = document.getElementById('companyName').value;
            document.getElementById('output-salutation').innerText = hiringManager || 'Hiring Team';

            const letterBodyContainer = document.getElementById('output-letterBody');
            letterBodyContainer.innerHTML = '';
            document.querySelectorAll('#chapters-container > div').forEach(chapter => {
                const content = chapter.querySelector('.content-text').value;
                if (content && content.trim()) {
                    const p = document.createElement('p');
                    p.innerText = content;
                    letterBodyContainer.appendChild(p);
                }
            });

            document.getElementById('output-signature').innerText = document.getElementById('name').value;
            
            document.getElementById('form-panel').style.display = 'none';
            document.getElementById('output-container').style.display = 'block';
            window.print();
            document.getElementById('form-panel').style.display = 'block';
            document.getElementById('output-container').style.display = 'none';
        }

        function resetForNewApplication() {
            document.getElementById('companyName').value = '';
            document.getElementById('hiringManager').value = '';
            document.getElementById('chapters-container').innerHTML = '';
            saveState();
        }

        window.onload = loadState;
    </script>
</body>
</html>
